<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>19.4. Login and Registration Forms &#8212; Java Web Development  documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/fa/css/all.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/launchcode.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/site.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="19.5. Filtering Requests" href="request-filtering.html" />
    <link rel="prev" title="19.3. Creating a User Model" href="user-model.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>

  </head><body class="body-bc">

<div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html"><span><img src="../../_static/lc-ed-logo.png" alt="LaunchCode logo"></span>
        </a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
    <label for="q" class="searchLabel">Search</label>
    <input type="text" name="q" class="form-control" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<ol class="breadcrumb container">
    <li><a href="../../index.html">Contents</a></li>
    <li><a href="index.html"><span class="section-number">19. </span>Authentication</a></li>
    <li class="active"><span class="section-number">19.4. </span>Login and Registration Forms</li>
</ol>



<div class="container">
  <div class="row">
    <div class="col-md-10 col-md-offset-1 content " role="main">

    
  <div class="section" id="login-and-registration-forms">
<h1><span class="section-number">19.4. </span>Login and Registration Forms<a class="headerlink" href="#login-and-registration-forms" title="Permalink to this headline">¶</a></h1>
<p>With a <code class="docutils literal notranslate"><span class="pre">User</span></code> class in place, we can now create controllers and views for creating a user and verifying their credentials.</p>
<div class="section" id="creating-authenticationcontroller">
<h2><span class="section-number">19.4.1. </span>Creating <code class="docutils literal notranslate"><span class="pre">AuthenticationController</span></code><a class="headerlink" href="#creating-authenticationcontroller" title="Permalink to this headline">¶</a></h2>
<p>In the <code class="docutils literal notranslate"><span class="pre">controllers</span></code> package, create a new class named <code class="docutils literal notranslate"><span class="pre">AuthenticationController</span></code>. Since this controller will deal with <code class="docutils literal notranslate"><span class="pre">User</span></code> objects, it needs a <code class="docutils literal notranslate"><span class="pre">UserRepository</span></code> instance.</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthenticationController</span> <span class="p">{</span>

   <span class="nd">@Autowired</span>
   <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="p">;</span>

<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="session-handling-utilities">
<h2><span class="section-number">19.4.2. </span>Session-Handling Utilities<a class="headerlink" href="#session-handling-utilities" title="Permalink to this headline">¶</a></h2>
<p>Before creating handler methods for rendering and processing our login and registration forms, we need some utility methods for working with sessions. Below the definition of <code class="docutils literal notranslate"><span class="pre">userRepository</span></code>, let’s add the following class members:</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">userSessionKey</span> <span class="o">=</span> <span class="s">&quot;user&quot;</span><span class="p">;</span>

<span class="kd">public</span> <span class="n">User</span> <span class="nf">getUserFromSession</span><span class="p">(</span><span class="n">HttpSession</span> <span class="n">session</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">Integer</span> <span class="n">userId</span> <span class="o">=</span> <span class="p">(</span><span class="n">Integer</span><span class="p">)</span> <span class="n">session</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="n">userSessionKey</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">userId</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">Optional</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="n">user</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setUserInSession</span><span class="p">(</span><span class="n">HttpSession</span> <span class="n">session</span><span class="p">,</span> <span class="n">User</span> <span class="n">user</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">session</span><span class="p">.</span><span class="na">setAttribute</span><span class="p">(</span><span class="n">userSessionKey</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>This code allows us to store and retrieve the login status of a user in a session. More specifically, a logged-in user’s user ID will be stored in their session.</p>
<table border="1" class="docutils align-default" id="id1">
<caption><span class="caption-text">Sample session data for a logged-in user</span><a class="headerlink" href="#id1" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><th class="stub">session_id</th>
<td>81LfWG9</td>
</tr>
<tr class="row-even"><th class="stub">user</th>
<td>42</td>
</tr>
</tbody>
</table>
<p>The static field <code class="docutils literal notranslate"><span class="pre">userSessionKey</span></code> is the key used to store user IDs. <code class="docutils literal notranslate"><span class="pre">setUserInSession</span></code> uses an <code class="docutils literal notranslate"><span class="pre">HttpSession</span></code> object (part of the standard <code class="docutils literal notranslate"><span class="pre">javax.servlet.http</span></code> package) to store key/value pair. <code class="docutils literal notranslate"><span class="pre">getUserFromSession</span></code> looks for data with the key <code class="docutils literal notranslate"><span class="pre">user</span></code> in the user’s session. If it finds one, it attempts to retrieve the corresponding <code class="docutils literal notranslate"><span class="pre">User</span></code> object from the database. If no user ID is in the session, or if there is no user with the given ID, <code class="docutils literal notranslate"><span class="pre">null</span></code> is returned.</p>
<div class="admonition-note admonition">
<p class="first admonition-title"><i class="fas fa-sticky-note" aria-hidden="true"></i>Note</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">HttpSession</span></code> class handles the details of session creation and lookup for us, including generating unique session IDs and session cookies.</p>
</div>
<p>These utility methods will allow our handlers to manage authentication.</p>
</div>
<div class="section" id="form-dtos">
<h2><span class="section-number">19.4.3. </span>Form DTOs<a class="headerlink" href="#form-dtos" title="Permalink to this headline">¶</a></h2>
<p>Our login and registration forms will use DTOs to help with form rendering and processing. Furthermore, since these forms will be similar—both require a username and password—we’ll use inheritance in creating our DTOs.</p>
<p>The DTO for the login form needs only <code class="docutils literal notranslate"><span class="pre">username</span></code> and <code class="docutils literal notranslate"><span class="pre">password</span></code> fields.</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginFormDTO</span> <span class="p">{</span>

   <span class="nd">@NotNull</span>
   <span class="nd">@NotBlank</span>
   <span class="nd">@Size</span><span class="p">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Invalid username. Must be between 3 and 20 characters.&quot;</span><span class="p">)</span>
   <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="p">;</span>

   <span class="nd">@NotNull</span>
   <span class="nd">@NotBlank</span>
   <span class="nd">@Size</span><span class="p">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Invalid password. Must be between 5 and 30 characters.&quot;</span><span class="p">)</span>
   <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="p">;</span>

   <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUsername</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">username</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUsername</span><span class="p">(</span><span class="n">String</span> <span class="n">username</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="na">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPassword</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">password</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPassword</span><span class="p">(</span><span class="n">String</span> <span class="n">password</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="p">;</span>
   <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p><code class="docutils literal notranslate"><span class="pre">LoginFormDTO</span></code> should live in the <code class="docutils literal notranslate"><span class="pre">models.dto</span></code> package.</p>
<div class="admonition-tip admonition">
<p class="first admonition-title"><i class="fas fa-lightbulb" aria-hidden="true"></i>Tip</p>
<p class="last">To better understand this approach, think of a DTO associated with a form as an object that represents each of the form fields. Using a DTO to represent the data associated with a form makes form rendering and processing much easier when the form does not line up with a specific model class.</p>
</div>
<div class="admonition-note admonition">
<p class="first admonition-title"><i class="fas fa-sticky-note" aria-hidden="true"></i>Note</p>
<p class="last">In the class above, we have a password field that will store a plain-text password. However, this does not contradict our early imperative about NOT storing passwords, since <code class="docutils literal notranslate"><span class="pre">LoginFormDTO</span></code> is not a persistent class.</p>
</div>
<p>Our registration form will ask for a username/password pair, and then ask the user to confirm the password by typing it in again. So the associated DTO can extend <code class="docutils literal notranslate"><span class="pre">LoginFormDTO</span></code> and add an additional field for password verification.</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RegisterFormDTO</span> <span class="kd">extends</span> <span class="n">LoginFormDTO</span> <span class="p">{</span>

   <span class="kd">private</span> <span class="n">String</span> <span class="n">verifyPassword</span><span class="p">;</span>

   <span class="kd">public</span> <span class="n">String</span> <span class="nf">getVerifyPassword</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">verifyPassword</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setVerifyPassword</span><span class="p">(</span><span class="n">String</span> <span class="n">verifyPassword</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="na">verifyPassword</span> <span class="o">=</span> <span class="n">verifyPassword</span><span class="p">;</span>
   <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p><code class="docutils literal notranslate"><span class="pre">RegisterFormDTO</span></code> should also live in the <code class="docutils literal notranslate"><span class="pre">models.dto</span></code> package.</p>
</div>
<div class="section" id="the-registration-form">
<h2><span class="section-number">19.4.4. </span>The Registration Form<a class="headerlink" href="#the-registration-form" title="Permalink to this headline">¶</a></h2>
<p>We are now ready to build our form handlers. Before we can authenticate a user, we must have users in the application, so we’ll build the registration form first.</p>
<p>To render the form within <code class="docutils literal notranslate"><span class="pre">AuthenticationController</span></code> is simple:</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>48
49
50
51
52
53</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/register&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">displayRegistrationForm</span><span class="p">(</span><span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="k">new</span> <span class="n">RegisterFormDTO</span><span class="p">());</span>
   <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">,</span> <span class="s">&quot;Register&quot;</span><span class="p">);</span>
   <span class="k">return</span> <span class="s">&quot;register&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="admonition-note admonition">
<p class="first admonition-title"><i class="fas fa-sticky-note" aria-hidden="true"></i>Note</p>
<p>When passing an object into the view with <code class="docutils literal notranslate"><span class="pre">model.addAttribute</span></code>, specifying a label for the object is optional. If a label is not specified the class name is used, with the first letter converted to lowercase.</p>
<p class="last">In the method above, <code class="docutils literal notranslate"><span class="pre">model.addAttribute(new</span> <span class="pre">RegisterFormDTO())</span></code> will pass a <code class="docutils literal notranslate"><span class="pre">RegisterFormDTO</span></code> object in with the label <code class="docutils literal notranslate"><span class="pre">registerFormDTO</span></code>.</p>
</div>
<p>The registration form (in <code class="docutils literal notranslate"><span class="pre">templates/register.html</span></code>) uses the three DTO fields to render the form fields:</p>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span> <span class="na">xmlns:th</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org/&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span> <span class="na">th:replace</span><span class="o">=</span><span class="s">&quot;fragments :: head&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container&quot;</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">header</span> <span class="na">th:replace</span><span class="o">=</span><span class="s">&quot;fragments :: header&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">header</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>Username
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-control&quot;</span> <span class="na">th:field</span><span class="o">=</span><span class="s">&quot;${registerFormDTO.username}&quot;</span> <span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;error&quot;</span> <span class="na">th:errors</span><span class="o">=</span><span class="s">&quot;${registerFormDTO.username}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
   <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>Password
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-control&quot;</span> <span class="na">th:field</span><span class="o">=</span><span class="s">&quot;${registerFormDTO.password}&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;password&quot;</span> <span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;error&quot;</span> <span class="na">th:errors</span><span class="o">=</span><span class="s">&quot;${registerFormDTO.password}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
   <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>Verify Password
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-control&quot;</span> <span class="na">th:field</span><span class="o">=</span><span class="s">&quot;${registerFormDTO.verifyPassword}&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;password&quot;</span> <span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
   <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

   <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Register&quot;</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table></div>
<p>The form processing handler is more complicated. Let’s look at it, and then break it down in detail.</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/register&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">processRegistrationForm</span><span class="p">(</span><span class="nd">@ModelAttribute</span> <span class="nd">@Valid</span> <span class="n">RegisterFormDTO</span> <span class="n">registerFormDTO</span><span class="p">,</span>
                     <span class="n">Errors</span> <span class="n">errors</span><span class="p">,</span> <span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span>
                     <span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">errors</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">,</span> <span class="s">&quot;Register&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="s">&quot;register&quot;</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">User</span> <span class="n">existingUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="p">.</span><span class="na">findByUsername</span><span class="p">(</span><span class="n">registerFormDTO</span><span class="p">.</span><span class="na">getUsername</span><span class="p">());</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">existingUser</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">errors</span><span class="p">.</span><span class="na">rejectValue</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">,</span> <span class="s">&quot;username.alreadyexists&quot;</span><span class="p">,</span> <span class="s">&quot;A user with that username already exists&quot;</span><span class="p">);</span>
      <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">,</span> <span class="s">&quot;Register&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="s">&quot;register&quot;</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">registerFormDTO</span><span class="p">.</span><span class="na">getPassword</span><span class="p">();</span>
   <span class="n">String</span> <span class="n">verifyPassword</span> <span class="o">=</span> <span class="n">registerFormDTO</span><span class="p">.</span><span class="na">getVerifyPassword</span><span class="p">();</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">password</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">verifyPassword</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">errors</span><span class="p">.</span><span class="na">rejectValue</span><span class="p">(</span><span class="s">&quot;password&quot;</span><span class="p">,</span> <span class="s">&quot;passwords.mismatch&quot;</span><span class="p">,</span> <span class="s">&quot;Passwords do not match&quot;</span><span class="p">);</span>
      <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">,</span> <span class="s">&quot;Register&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="s">&quot;register&quot;</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">User</span> <span class="n">newUser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="p">(</span><span class="n">registerFormDTO</span><span class="p">.</span><span class="na">getUsername</span><span class="p">(),</span> <span class="n">registerFormDTO</span><span class="p">.</span><span class="na">getPassword</span><span class="p">());</span>
   <span class="n">userRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">newUser</span><span class="p">);</span>
   <span class="n">setUserInSession</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">(),</span> <span class="n">newUser</span><span class="p">);</span>

   <span class="k">return</span> <span class="s">&quot;redirect:&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<ul class="simple">
<li><strong>Lines 55-58</strong>: Define the handler method at the route <code class="docutils literal notranslate"><span class="pre">/register</span></code> that takes a valid <code class="docutils literal notranslate"><span class="pre">RegisterFormDTO</span></code> object, associated errors, and a <code class="docutils literal notranslate"><span class="pre">Model</span></code>. In addition, the method needs an <code class="docutils literal notranslate"><span class="pre">HttpServletRequest</span></code> object. This object represents the incoming request, and will be provided by Spring.</li>
<li><strong>Lines 60-63</strong>: Return the user to the form if an validation errors occur.</li>
<li><strong>Line 65</strong>: Retrieve the user with the given username from the database.</li>
<li><strong>Lines 67-71</strong>: If a user with the given username already exists, register a custom error with the <code class="docutils literal notranslate"><span class="pre">errors</span></code> object and return the user to the form. See the note on using <code class="docutils literal notranslate"><span class="pre">errors.rejectValue</span></code> below.</li>
<li><strong>Lines 73-79</strong>: Compare the two passwords submitted. If they do not match, register a custom error and return the user to the form.</li>
<li><strong>Lines 81-83</strong>: At this point, we know that a user with the given username does NOT already exist, and the rest of the form data is valid. So we create a new user object, store it in the database, and then create a new session for the user.</li>
<li><strong>Line 85</strong>: Finally, redirect the user to the home page.</li>
</ul>
<div class="admonition-note admonition">
<p class="first admonition-title"><i class="fas fa-sticky-note" aria-hidden="true"></i>Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Errors</span></code> class we have been using in conjunction with model binding will always contain information about errors related to validation annotations on the given model. However, it can also be used to manually generate additional errors. In the method above, we call:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">errors</span><span class="p">.</span><span class="na">rejectValue</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">,</span> <span class="s">&quot;username.alreadyexists&quot;</span><span class="p">,</span>
                   <span class="s">&quot;A user with that username already exists&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">errors.rejectValue</span></code> takes three parameters:</p>
<ol class="last arabic simple">
<li>The field containing the error.</li>
<li>A label representing the error. This allows error messages to be imported from another file. While we don’t have such a file, this parameter is required.</li>
<li>A default message to use if no external error message file is available (as is the case here).</li>
</ol>
</div>
<p>This is a good time to test your application. Start it up, navigate to <code class="docutils literal notranslate"><span class="pre">/register</span></code> and try to create a user. If everything goes well, you will see a new row in the <code class="docutils literal notranslate"><span class="pre">user</span></code> table of the database.</p>
<div class="figure align-default" id="id2">
<img alt="The user table with a new row containing id, pw_hash, and username values" src="../../_images/user-in-db.png" />
<p class="caption"><span class="caption-text">A new row in the <code class="docutils literal notranslate"><span class="pre">user</span></code> table</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="the-login-form">
<h2><span class="section-number">19.4.5. </span>The Login Form<a class="headerlink" href="#the-login-form" title="Permalink to this headline">¶</a></h2>
<p>Rendering the login form is similar to rendering the registration form:</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>89
90
91
92
93
94</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/login&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">displayLoginForm</span><span class="p">(</span><span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="k">new</span> <span class="n">LoginFormDTO</span><span class="p">());</span>
   <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">,</span> <span class="s">&quot;Log In&quot;</span><span class="p">);</span>
   <span class="k">return</span> <span class="s">&quot;login&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The form template itself should be placed in <code class="docutils literal notranslate"><span class="pre">templates/login.html</span></code>, and is
also similar to the registration template:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span> <span class="na">xmlns:th</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org/&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span> <span class="na">th:replace</span><span class="o">=</span><span class="s">&quot;fragments :: head&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container&quot;</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">header</span> <span class="na">th:replace</span><span class="o">=</span><span class="s">&quot;fragments :: header&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">header</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">label</span> <span class="na">th:for</span><span class="o">=</span><span class="s">&quot;username&quot;</span><span class="p">&gt;</span>Username
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-control&quot;</span> <span class="na">th:field</span><span class="o">=</span><span class="s">&quot;${loginFormDTO.username}&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;error&quot;</span> <span class="na">th:errors</span><span class="o">=</span><span class="s">&quot;${loginFormDTO.username}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
   <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>Password
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-control&quot;</span> <span class="na">th:field</span><span class="o">=</span><span class="s">&quot;${loginFormDTO.password}&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;password&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;error&quot;</span> <span class="na">th:errors</span><span class="o">=</span><span class="s">&quot;${loginFormDTO.password}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
   <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

   <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Log In&quot;</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Don&#39;t have an account? <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;/register&quot;</span><span class="p">&gt;</span>Register for one.<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>As usual, processing the form is more complicated. Again, we’ll break it down in detail.</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/login&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">processLoginForm</span><span class="p">(</span><span class="nd">@ModelAttribute</span> <span class="nd">@Valid</span> <span class="n">LoginFormDTO</span> <span class="n">loginFormDTO</span><span class="p">,</span>
                  <span class="n">Errors</span> <span class="n">errors</span><span class="p">,</span> <span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span>
                  <span class="n">Model</span> <span class="n">model</span><span class="p">)</span> <span class="p">{</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">errors</span><span class="p">.</span><span class="na">hasErrors</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">,</span> <span class="s">&quot;Log In&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="s">&quot;login&quot;</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">User</span> <span class="n">theUser</span> <span class="o">=</span> <span class="n">userRepository</span><span class="p">.</span><span class="na">findByUsername</span><span class="p">(</span><span class="n">loginFormDTO</span><span class="p">.</span><span class="na">getUsername</span><span class="p">());</span>

     <span class="k">if</span> <span class="p">(</span><span class="n">theUser</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">errors</span><span class="p">.</span><span class="na">rejectValue</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">,</span> <span class="s">&quot;user.invalid&quot;</span><span class="p">,</span> <span class="s">&quot;The given username does not exist&quot;</span><span class="p">);</span>
         <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">,</span> <span class="s">&quot;Log In&quot;</span><span class="p">);</span>
         <span class="k">return</span> <span class="s">&quot;login&quot;</span><span class="p">;</span>
     <span class="p">}</span>

     <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">loginFormDTO</span><span class="p">.</span><span class="na">getPassword</span><span class="p">();</span>

     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">theUser</span><span class="p">.</span><span class="na">isMatchingPassword</span><span class="p">(</span><span class="n">password</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">errors</span><span class="p">.</span><span class="na">rejectValue</span><span class="p">(</span><span class="s">&quot;password&quot;</span><span class="p">,</span> <span class="s">&quot;password.invalid&quot;</span><span class="p">,</span> <span class="s">&quot;Invalid password&quot;</span><span class="p">);</span>
      <span class="n">model</span><span class="p">.</span><span class="na">addAttribute</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">,</span> <span class="s">&quot;Log In&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="s">&quot;login&quot;</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">setUserInSession</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">(),</span> <span class="n">theUser</span><span class="p">);</span>

   <span class="k">return</span> <span class="s">&quot;redirect:&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<ul class="simple">
<li><strong>Lines 96-104</strong>: The method definition, parameters, and initial error checking are nearly identical to the registration <code class="docutils literal notranslate"><span class="pre">POST</span></code> handler above.</li>
<li><strong>Line 106</strong>: Retrieves the <code class="docutils literal notranslate"><span class="pre">User</span></code> object with the given password from the database.</li>
<li><strong>Lines 108-112</strong>: If no such user exists, register a custom error and return to the form.</li>
<li><strong>Line 114</strong>: Retrieves the <em>submitted</em> password from the form DTO.</li>
<li><strong>Lines 116-120</strong>: If the password is incorrect, register a custom error and return to the form. Password verification uses the <code class="docutils literal notranslate"><span class="pre">User.isMatchingPassword()</span></code> method, which handles the details associated with checking hashed passwords.</li>
<li><strong>Line 122</strong>: At this point, we know the given user exists and that the submitted password is correct. So we create a new session for the user.</li>
<li><strong>Line 124</strong>: Finally, redirect the user to the home page.</li>
</ul>
<p>Now you can test your login form. Upon successful form submission, you should be redirected to the home page. To verify that a session was created, open Firefox’s developer tools and navigate to the <em>Storage</em> pane. Select <em>Cookies &gt; http://localhost:8080</em> in the left-hand pane and you should see a cookie with the key <code class="docutils literal notranslate"><span class="pre">JSESSIONID</span></code>. This is the session cookie created by the application. (You may see other cookies as well, which is okay.)</p>
<div class="figure align-default" id="id3">
<img alt="A session cookie visible in the Storage pane of the browser's dev tools." src="../../_images/session-cookie.png" />
<p class="caption"><span class="caption-text">A session cookie for our application</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="logging-out">
<h2><span class="section-number">19.4.6. </span>Logging Out<a class="headerlink" href="#logging-out" title="Permalink to this headline">¶</a></h2>
<p>After the complicated processes of user registration and login, logging a user
out is refreshingly simple.</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>127
128
129
130
131</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/logout&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">logout</span><span class="p">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="p">){</span>
   <span class="n">request</span><span class="p">.</span><span class="na">getSession</span><span class="p">().</span><span class="na">invalidate</span><span class="p">();</span>
   <span class="k">return</span> <span class="s">&quot;redirect:/login&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>To log out, we simply invalidate the session associated with the given user.
This removes all data from the session, so that when the user makes a
subsequent request, they will be forced to log in again.</p>
<div class="admonition-note admonition">
<p class="first admonition-title"><i class="fas fa-sticky-note" aria-hidden="true"></i>Note</p>
<p class="last">The code for this section is available in the
<a class="reference external" href="https://github.com/LaunchCodeEducation/coding-events/tree/login-reg-forms" target="_blank">login-reg-forms branch<i class="fas fa-external-link-alt" aria-hidden="true"></i></a>
of the <code class="docutils literal notranslate"><span class="pre">coding-events-demo</span></code> repository.</p>
</div>
</div>
<div class="section" id="check-your-understanding">
<h2><span class="section-number">19.4.7. </span>Check Your Understanding<a class="headerlink" href="#check-your-understanding" title="Permalink to this headline">¶</a></h2>
<div class="admonition-question admonition">
<p class="first admonition-title"><i class="fas fa-question" aria-hidden="true"></i>Question</p>
<p>What is the name of the new method we have introduced on the <code class="docutils literal notranslate"><span class="pre">Errors</span></code> object?</p>
<ol class="last arabic simple">
<li><code class="docutils literal notranslate"><span class="pre">Errors.hasErrors()</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Errors.errors()</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Errors.isNotEmpty()</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">Errors.rejectValue()</span></code></li>
</ol>
</div>
<div class="admonition-question admonition">
<p class="first admonition-title"><i class="fas fa-question" aria-hidden="true"></i>Question</p>
<p>Which developer tool panel can we use to verify that a user session has been started?</p>
<ol class="last arabic simple">
<li>Console</li>
<li>Network</li>
<li>Storage</li>
<li>Performance</li>
</ol>
</div>
</div>
</div>



    
    <nav aria-label="Next and Previous Pages">
      <ul class="pager">
        
        <li class="previous"><a href="user-model.html"><span aria-hidden="true">&larr;</span> <span class="section-number">19.3. </span>Creating a <code class="docutils literal notranslate"><span class="pre">User</span></code> Model</a></li>
        
        
        <li class="next"><a href="request-filtering.html"><span class="section-number">19.5. </span>Filtering Requests <span aria-hidden="true">&rarr;</span></a></li>
        
      </ul>
    </nav>
    
    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../../_sources/chapters/auth/login-registration-forms.rst.txt"
     rel="nofollow">Page Source</a>
</div>
      
    </p>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>